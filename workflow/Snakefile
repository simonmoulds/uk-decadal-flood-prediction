AGGR = ['yr2', 'yr2to9', 'yr2to9_lag']
EXPM = ['hindcast', 'observed']

rule all:
    input:
        '../results/fig/fig1.png',
        '../results/fig/fig2.png',
        '../results/fig/fig3.png',
        '../results/fig/fig4.png',
        '../results/fig/figS1.png',
        '../results/fig/figS2.png',
        '../results/fig/figS3.png',
        '../results/fig/figS4.png'

rule obs_input:
    input:
        files='config.yml',
        script='scripts/Python/prepare-observed-input-data.py'
    output:
        'data/obs.parquet'
    params:
        outputdir='../results'
    shell:
        """
        python {input.script} -i {input.files} -o {params.outputdir}
        """

rule mod_input:
    input:
        files='config.yml',
        script='scripts/Python/prepare-modelled-input-data.py'
    output:
        directory('../results/ensemble-forecast')
    shell:
        """
        mkdir -p {output}
        python {input.script} -i {input.files} -o {output}
        """

rule get_discharge_data:
    input:
        files='../data-raw/UKBN/UKBN_Station_List_vUKBN2.0_1.csv',
        script='scripts/R/download-discharge-data.R'
    output:
        directory('../results/nrfa-discharge-summaries')
    shell:
        """
        Rscript {input.script} {input.files} {output}
        """

rule nao_matching:
    input:
        '../results/obs.parquet',
        '../results/ensemble-forecast',
        '../results/nrfa-discharge-summaries',
        files='config.yml',
        script='scripts/R/perform-nao-matching.R'
    output:
        '../results/analysis/{aggr}/obs_study_period.parquet',
        '../results/analysis/{aggr}/ensemble_fcst.parquet',
        '../results/analysis/{aggr}/ensemble_mean_fcst.parquet',
        '../results/analysis/{aggr}/matched_ensemble.parquet',
        '../results/analysis/{aggr}/matched_ensemble_error.parquet'
    params:
        outputdir='../results/analysis'
    shell:
        """
        Rscript {input.script} {input.files} {wildcards.aggr} {params.outputdir}
        """

rule build_catchment_dataset:
    input:
        '../results/nrfa-discharge-summaries',
        '../results/obs.parquet',
        expand('../results/analysis/{aggr}/matched_ensemble.parquet', aggr = AGGR),
        expand('../results/analysis/{aggr}/matched_ensemble_error.parquet', aggr = AGGR),
        files='config.yml',
        script='scripts/R/build-catchment-../resultsset.R'
    output:
        directory('../results/analysis/{aggr}/input')
    params:
        outputdir='../results'
    shell:
        """
        Rscript {input.script} {input.files} {wildcards.aggr} {params.outputdir}
        """

rule fit_models:
    input:
        expand('../results/analysis/{aggr}/input', aggr = AGGR),
        files='config.yml',
        script='scripts/R/fit-models.R'
    output:
        directory('../results/analysis/{expm}')
    wildcard_constraints:
        expm='|'.join([re.escape(x) for x in EXPM])
    params:
        outputdir='../results'
    shell:
        """
        Rscript {input.script} {input.files} {wildcards.expm} {params.outputdir}
        """

rule make_plots:
    input:
        expand('../results/analysis/{expm}', expm = EXPM),
        files='config.yml',
        script='scripts/R/evaluate-models.R'
    output:
        '../results/fig/fig1.png',
        '../results/fig/fig2.png',
        '../results/fig/fig3.png',
        '../results/fig/fig4.png',
        '../results/fig/figS1.png',
        '../results/fig/figS2.png',
        '../results/fig/figS3.png',
        '../results/fig/figS4.png'
    params:
        outputdir='../results/fig'
    shell:
        """
        Rscript {input.script} {input.files} {params.outputdir}
        """
